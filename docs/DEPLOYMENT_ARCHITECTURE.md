# Deployment Architecture & Content Management

## Current Architecture

### What Requires AC Game Files

**Required on Server:**

1. **AC Server Executable** (`acServer.exe`) - Must be present to run servers
2. **Server Config Files** - Generated by this app, stored in `AC_SERVER_PATH/cfg/`
3. **Track Data** - Physical track files must exist in `AC_CONTENT_PATH/tracks/`
4. **Car Data** - Physical car files must exist in `AC_CONTENT_PATH/cars/`

**Used by This App:**

1. **Content Scanning** - Reads `content/tracks/` and `content/cars/` for available options
2. **Metadata Extraction** - Reads `ui_track.json`, `ui_car.json`, tire data from car folders
3. **Preview Images** - Serves track/car preview images from content folder
4. **Server Process** - Spawns `acServer.exe` with config files

### Current Dependencies

```
App Dependencies on AC Files:
├── contentService.js
│   ├── getTracks() → Scans AC_CONTENT_PATH/tracks/
│   ├── getCars() → Scans AC_CONTENT_PATH/cars/
│   └── getTires() → Reads tyres.ini from car data folders
├── serverProcessManager.js
│   └── startServer() → Spawns AC_SERVER_PATH/acServer.exe
└── Routes serving preview images
    ├── /api/content/track-preview/:trackId
    └── /api/content/car-preview/:carId
```

## Alternative Deployment Models

### Option 1: **Headless Manager + Remote AC Server** (Recommended)

**Architecture:**

- Manager app runs on any machine (Windows/Linux server, cloud VM)
- AC server executable runs on Windows machine with game files
- Manager communicates with AC server via network

**Implementation:**

```
┌─────────────────────────────┐
│  Manager Server (Anywhere)  │
│  - Web UI                   │
│  - REST API                 │
│  - Static content database  │
│  - SSH/Remote execution     │
└──────────────┬──────────────┘
               │ SSH/PowerShell Remoting
               ▼
┌─────────────────────────────┐
│  AC Server Machine (Win)    │
│  - acServer.exe             │
│  - Track/Car content        │
│  - Config files             │
└─────────────────────────────┘
```

**Pros:**

- Manager can run on Linux/cheap cloud VM
- AC server stays on gaming PC or dedicated Windows server
- Centralized management of multiple AC servers

**Cons:**

- Requires SSH/PowerShell remoting setup
- Network latency for commands
- More complex deployment

### Option 2: **Static Content Database**

**Architecture:**

- Pre-built database of all AC tracks/cars/metadata
- App uses database instead of scanning filesystem
- Only AC server executable needed on deployment machine

**Implementation:**

```javascript
// Static content DB
const AC_CONTENT_DB = {
  tracks: [
    { id: 'imola', name: 'Imola', country: 'Italy', ... },
    { id: 'monza', name: 'Monza', country: 'Italy', ... },
    // ~500 official + popular mod tracks
  ],
  cars: [
    { id: 'abarth500', name: 'Abarth 500', ... },
    // ~180 official + popular mod cars
  ],
  tires: {
    'abarth500': ['ST', 'SV'],
    // Pre-indexed tire types per car
  }
};
```

**Pros:**

- No content scanning needed
- Fast startup (no filesystem I/O)
- Can run without full AC installation
- Works cross-platform

**Cons:**

- Mod content not automatically discovered
- Database needs manual updates for new mods
- Preview images need separate hosting

### Option 3: **Hybrid: Optional Local + Cloud Fallback**

**Architecture:**

- Detect if AC content exists locally
- If not, fall back to cloud-hosted content database
- Download only required content on-demand

**Implementation:**

```javascript
async function getTracks() {
  // Try local first
  if (await checkLocalContent()) {
    return scanLocalTracks();
  }

  // Fall back to cloud database
  return fetchFromCloudDB('https://api.ac-content.com/tracks');
}
```

**Pros:**

- Works both with and without local AC installation
- Auto-discovery of mods when local
- Can still function without game files

**Cons:**

- Requires cloud service/CDN for content database
- Complexity in dual-mode operation

### Option 4: **Container/Bundle Distribution**

**Architecture:**

- Distribute AC server executable + essential content as Docker container
- Manager app included in container
- Minimal footprint (~2-5GB vs 25GB full game)

**What to include:**

- `acServer.exe` (required)
- Essential tracks (10-20 popular ones)
- Essential cars (20-30 popular ones)
- Exclude: Single-player content, UI assets, shaders, etc.

**Pros:**

- Self-contained deployment
- Docker makes it platform-agnostic (with Wine/Proton)
- Reproducible environments

**Cons:**

- Legal questions about redistributing AC files
- Still ~2-5GB download
- Limited to bundled content

## Recommended Solution: **Static Content Database**

### Implementation Plan

1. **Create Content Database**

   ```javascript
   // backend/src/data/ac-content-db.json
   {
     "version": "1.0.0",
     "lastUpdated": "2025-11-30",
     "tracks": [...],
     "cars": [...],
     "tires": {...}
   }
   ```

2. **Content Service with Fallback**

   ```javascript
   async function getTracks() {
     // Try local scan first
     if (process.env.AC_CONTENT_PATH) {
       try {
         return await scanLocalTracks();
       } catch (e) {
         console.log('Local scan failed, using database');
       }
     }

     // Fall back to static database
     return loadFromStaticDB();
   }
   ```

3. **User Workflow**

   - **With AC Content**: Auto-discover all tracks/cars/mods
   - **Without AC Content**: Use static database (official content only)
   - **Hybrid**: Local discovery + manual content additions

4. **Preview Images**
   - Host on CDN or GitHub
   - Fallback to placeholder images
   - Optional: User can upload custom previews

### What Still Requires AC Installation

**Absolute Requirements:**

- `acServer.exe` executable (to actually run the server)
- Track files referenced in configs (server won't start without them)
- Car files referenced in configs (server won't start without them)

**Can Be Abstracted:**

- Content discovery (use static DB)
- Metadata (use static DB)
- Preview images (use CDN)
- Tire data (pre-indexed in DB)

## Minimal Deployment

**For Manager Only (no AC server execution):**

- Node.js runtime
- This app
- Static content database
- ~50MB total

**For Running AC Servers:**

- Windows machine (AC server is Windows-only)
- `acServer.exe` (~5MB)
- Required tracks (~10-500MB per track)
- Required cars (~10-100MB per car)
- Minimum ~500MB for basic setup

## Network Deployment Example

**Scenario**: Run manager on Linux VPS, AC servers on home Windows PC

```yaml
# docker-compose.yml on VPS
services:
  ac-manager:
    image: ac-server-manager:latest
    ports:
      - '3001:3001' # API
      - '5173:5173' # Frontend
    environment:
      - AC_SERVER_SSH=user@home-pc.ddns.net
      - AC_SERVER_PATH=/path/to/ac/server
      - USE_STATIC_CONTENT=true
```

**Manager SSH commands AC server remotely:**

```bash
ssh user@home-pc.ddns.net "cd /ac/server && ./acServer.exe ..."
```

## Conclusion

**Best Approach**: Static content database + optional local scanning

**Implementation Priority**:

1. ✅ Create static database of official AC content (~180 cars, ~20 tracks)
2. ✅ Modify contentService to use database when AC_CONTENT_PATH not set
3. ✅ Host preview images on CDN or bundle small thumbnails
4. ⬜ Add UI for manual content additions (for mods)
5. ⬜ Optional: SSH remote server management for separate deployments

This allows the app to function as a "manager" without full AC installation, while still supporting local content discovery when available.
